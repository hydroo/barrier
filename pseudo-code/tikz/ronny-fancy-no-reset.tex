\input{pre}

% preamble
\node [box, align=left] (pre)  {
	\begin{minipage}{12cm}
		\begin{itemize}
			\item constants:
				\begin{itemize}
					\item[] \textbf{integer} nthreads {\color{gray} number of threads}
					\item[] \textbf{integer} me {\color{gray} thread identificator (0..nthreads-1)}
					\item[] \textbf{integer} meBit := 2$^{me}$
					\item[] \textbf{integer} full := $\sum_{i=0}^{nthreads-1}2^i$
					\item[] \textbf{integer} empty := 0
				\end{itemize}
			\item shared variables:
				\begin{itemize}
					\item[] \textbf{integer} barrier[0..nthreads-1] \color{gray}each element on an own cacheline
				\end{itemize}
			\item local variables:
				\begin{itemize}
					\item[] \textbf{integer} i
				\end{itemize}
			\item initialize:
				\begin{itemize}
					\item[] barrier[*] := empty
					\item[] i := 0
				\end{itemize}
		\end{itemize}
	\end{minipage}
};

% nodes
\node [o, below of=pre, draw=none, yshift=-3cm, xshift=-3cm]  (init) {};
\node [o, below right of=init]                         (1)    {};
\node [o, below right of=1]                            (2)    {};
\node [o, below right of=2]                            (3)    {};
\node [o, below of=3]                      (4) {};
\node [o, below left of=4]                      (5) {};
\node [o, below of=5, draw=none]                 (done) {};

%  edges
\path [->] (init) edge                                       node [left]  {\color{gray}(work period)} (1);
\path [->] (1)    edge                                       node [left]  {barrier[me] := me \color{gray}(local shared write)} (2);
\path [->] (2)    edge [loop, distance=1.5cm, out=90, in=35] node [right] {barrier[me]\&2$^i$ = 1 \&\& i $<$ nthreads : i := i + 1 \color{gray}(local shared read)} (2);
\path [->] (2)    edge [out=-90, in=180] node [below left]  {else \color{gray}(local shared read)} (3);
\path [->] (3)    edge [out=90, in=0]    node [above right] {i = nthreads : i := 0}                (2);
\path [->] (3)    edge                   node [right] {else : tmp := barrier[i] \color{gray}(remote shared read)} (4);
\path [->] (4)    edge [out=-90, in=0]   node [below right] {barrier[me] := barrier[me] \textbar~tmp \color{gray}(local shared read+write)} (5);
\path [->] (5)    edge [distance=6cm, out=180, in=180]       node         {barrier[me] $\ne$ full \color{gray}(local shared read)} (2);
\path [->] (5)    edge                                       node         {else}                                                    (done);

\input{post}

