%
% TODO beautify me
% TODO update me. the prism model collapsed the whole "else -> test" into one transition that is a remote get
%

\input{pre}

% preamble
\node [box, align=left] (pre)  {
	\begin{minipage}{12cm}
		\begin{itemize}
			\item constants:
				\begin{itemize}
					\item[] \textbf{integer} nthreads {\color{gray} number of threads}
					\item[] \textbf{integer} me {\color{gray} thread identificator (0..nthreads-1)}
					\item[] \textbf{integer} meBit := 2$^{me}$
					\item[] \textbf{integer} full := $\sum_{i=0}^{nthreads-1}2^i$
					\item[] \textbf{integer} empty := 0
				\end{itemize}
			\item shared variables:
				\begin{itemize}
					\item[] \textbf{integer} barrier[0..nthreads-1] \color{gray}each element on an own cacheline
				\end{itemize}
			\item local variables:
				\begin{itemize}
					\item[] \textbf{integer} i
				\end{itemize}
			\item initialize:
				\begin{itemize}
					\item[] barrier[*] := empty
					\item[] i := me + 1 (\textbf{mod} nthreads)
				\end{itemize}
		\end{itemize}
	\end{minipage}
};

% nodes
\node [o, below of=pre, draw=none, yshift=-3cm, xshift=-3cm]  (init) {};
\node [o, below right of=init]                         (1)    {};
\node [o, below right of=1]                            (2)    {};
\node [o, below of=2]                                  (3)    {};
\node [o, below of=3, draw=none]                       (done) {};

%  edges
\path [->] (init) edge                                       node [left]  {\color{gray}(work period)} (1);
\path [->] (1)    edge                                       node [left]  {barrier[me] := me \color{gray}(local shared write)} (2);
\path [->] (2)    edge [loop, distance=1.5cm, out=90, in=35] node [right] {barrier[me]\&2$^i$ = 1 : i := i + 1 (\textbf{mod} nthreads) \color{gray}(local shared read)} (2);
\path [->] (2)    edge                   node [right]       {else : barrier[me] := barrier[me] \textbar~barrier[i] \color{gray}(local shared write + local shared read + remote shared read)} (3);
\path [->] (3)    edge [out=180, in=180] node               {barrier[me] $\ne$ full \color{gray}(local shared read)}    (2);
\path [->] (3)    edge                   node               {else}                                                      (done);

\input{post}

